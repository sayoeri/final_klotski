<script>
  let boardEl = document.getElementById("board");
  let movesEl = document.getElementById("moves");
  let timerEl = document.getElementById("timer");
  let sizeSelect = document.getElementById("size");

  let board = [],
      size = 4,
      emptyIndex = 0,
      moves = 0,
      timer = 0,
      timerInterval = null;

  function initBoardOrdered() {
    size = parseInt(sizeSelect.value);
    board = [...Array(size * size).keys()];
    emptyIndex = board.indexOf(0);
    renderBoard();
    movesEl.textContent = "0";
    timerEl.textContent = "00:00";
  }

  function startGame() {
    clearInterval(timerInterval);
    timer = 0;
    moves = 0;
    movesEl.textContent = "0";
    timerEl.textContent = "00:00";

    size = parseInt(sizeSelect.value);
    do {
      board = [...Array(size * size).keys()];
      shuffleBoard();
    } while (!isSolvable(board));

    emptyIndex = board.indexOf(0);
    renderBoard();

    timerInterval = setInterval(() => {
      timer++;
      let min = String(Math.floor(timer / 60)).padStart(2, '0');
      let sec = String(timer % 60).padStart(2, '0');
      timerEl.textContent = `${min}:${sec}`;
    }, 1000);
  }

  function shuffleBoard() {
    for (let i = board.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [board[i], board[j]] = [board[j], board[i]];
    }
  }

  function isSolvable(b) {
    const inv = getInversionCount(b);
    if (size % 2 === 1) {
      return inv % 2 === 0;
    } else {
      const rowFromBottom = size - Math.floor(b.indexOf(0) / size);
      return (inv + rowFromBottom) % 2 === 0;
    }
  }

  function getInversionCount(arr) {
    let inv = 0;
    const flat = arr.filter(x => x !== 0);
    for (let i = 0; i < flat.length - 1; i++) {
      for (let j = i + 1; j < flat.length; j++) {
        if (flat[i] > flat[j]) inv++;
      }
    }
    return inv;
  }

  function renderBoard() {
    boardEl.innerHTML = "";
    boardEl.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
    board.forEach((num, i) => {
      const tile = document.createElement("div");
      tile.className = "tile" + (num === 0 ? " empty" : "");
      tile.textContent = num !== 0 ? num : "";
      tile.style.height = tile.style.width = `${400 / size}px`;
      tile.addEventListener("click", () => moveTile(i));
      boardEl.appendChild(tile);
    });
  }

  function moveTile(i) {
    const targetRow = Math.floor(i / size);
    const targetCol = i % size;
    const emptyRow = Math.floor(emptyIndex / size);
    const emptyCol = emptyIndex % size;

    const distance = Math.abs(targetRow - emptyRow) + Math.abs(targetCol - emptyCol);
    if (distance === 1) {
      [board[i], board[emptyIndex]] = [board[emptyIndex], board[i]];
      emptyIndex = i;
      moves++;
      movesEl.textContent = moves;
      renderBoard();

      if (isSolved()) {
        clearInterval(timerInterval);
        setTimeout(() => {
          alert(`ğŸ‰ æ­å–œé€šå…³ï¼\næ­¥æ•°: ${moves} \nç”¨æ—¶: ${timerEl.textContent}`);
        }, 100);
      }
    }
  }

  function isSolved() {
    return board.every((val, idx) => val === idx);
  }

  // åˆå§‹æ˜¾ç¤ºé¡ºåºæ£‹ç›˜ï¼ˆä¸è®¡æ—¶ï¼‰
  initBoardOrdered();
</script>
